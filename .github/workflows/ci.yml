name: ci
on:
  push:
  pull_request:

jobs:
  test_python_db:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: etl
          POSTGRES_PASSWORD: etl
          POSTGRES_DB: etldb
        ports: ["5432:5432"]
        options: >-
          --health-cmd "pg_isready -U etl"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20
      clickhouse:
        image: clickhouse/clickhouse-server:24.8
        ports: ["8123:8123", "9000:9000"]
        options: >-
          --health-cmd "bash -c 'echo \"SELECT 1\" | clickhouse-client || exit 1'"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install sqlalchemy psycopg[binary] clickhouse-connect

      - name: Test Postgres and ClickHouse connections
        run: |
          python - <<'PY'
          import sqlalchemy as sa
          import clickhouse_connect

          print("Connecting to Postgres...")
          pg = sa.create_engine("postgresql+psycopg://etl:etl@localhost:5432/etldb", future=True)
          with pg.begin() as conn:
              result = conn.execute(sa.text("SELECT 1"))
              print("Postgres result:", result.scalar())

          print("Connecting to ClickHouse...")
          ch = clickhouse_connect.get_client(host="localhost", port=8123)
          print("ClickHouse version:", ch.command("SELECT version()"))
          PY
